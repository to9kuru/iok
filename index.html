<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>弱いやつから死んでいく</title>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #050505;
    user-select: none;
}
canvas {
    display: block;
    touch-action: none;
}
#ui {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    color: #fff;
}
#score {
    position: absolute;
    top: 20px;
    left: 20px;
    color: #0ff;
    font-family: monospace;
    font-size: 1.5rem;
}
#gameover {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.85);
    color: #fff;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}
button {
    margin-top: 30px;
    padding: 15px 40px;
    font-size: 1.2rem;
}
</style>
</head>

<body>

<div id="score">0.00</div>

<div id="ui">
    <h1>IOK</h1>
    <p>画面を押して開始</p>
</div>

<div id="gameover">
    <h1>GAME OVER</h1>
    <p id="final"></p>
    <button onclick="resetGame()">Retry</button>
</div>

<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

let w, h;
let isPlaying = false;
let isInputActive = false;
let animationId;
let startTime;

const player = {
    x: 0,
    y: 0,
    targetX: 0,
    targetY: 0,
    r: 18,
    speed: 6
};

let enemies = [];

/* ===== 初期化 ===== */
function resize() {
    w = canvas.width = innerWidth;
    h = canvas.height = innerHeight;
    player.x = player.targetX = w / 2;
    player.y = player.targetY = h / 2;
    drawIdle();
}
addEventListener("resize", resize);

/* ===== 入力 ===== */
canvas.addEventListener("pointerdown", e => {
    isInputActive = true;
    setTarget(e.clientX, e.clientY);
    if (!isPlaying) startGame();
});

canvas.addEventListener("pointermove", e => {
    if (!isInputActive || !isPlaying) return;
    setTarget(e.clientX, e.clientY);
});

canvas.addEventListener("pointerup", () => {
    isInputActive = false;
    player.targetX = player.x;
    player.targetY = player.y;
});

canvas.addEventListener("pointercancel", () => {
    isInputActive = false;
});

/* ===== ターゲット ===== */
function setTarget(x, y) {
    player.targetX = x;
    player.targetY = y;
}

/* ===== ゲーム制御 ===== */
function startGame() {
    isPlaying = true;
    enemies = [];
    startTime = Date.now();
    document.getElementById("ui").style.display = "none";
    document.getElementById("gameover").style.display = "none";
    loop();
}

function resetGame() {
    isPlaying = false;
    document.getElementById("ui").style.display = "flex";
    drawIdle();
}

/* ===== 自機移動 ===== */
function movePlayer() {
    if (!isInputActive) return;
    const dx = player.targetX - player.x;
    const dy = player.targetY - player.y;
    const dist = Math.hypot(dx, dy);
    if (dist > 0.1) {
        const m = Math.min(player.speed, dist);
        player.x += dx / dist * m;
        player.y += dy / dist * m;
    }
}

/* ===== 敵 ===== */
function spawnEnemy(diff) {
    const r = 10 + Math.random() * 10;
    const side = Math.floor(Math.random() * 4);
    let x, y;
    if (side === 0) { x = Math.random() * w; y = -30; }
    if (side === 1) { x = w + 30; y = Math.random() * h; }
    if (side === 2) { x = Math.random() * w; y = h + 30; }
    if (side === 3) { x = -30; y = Math.random() * h; }

    const a = Math.atan2(player.y - y, player.x - x);
    const s = 2.5 + diff * 0.6;

    enemies.push({
        x, y,
        vx: Math.cos(a) * s,
        vy: Math.sin(a) * s,
        r
    });
}

/* ===== 描画 ===== */
function drawIdle() {
    ctx.fillStyle = "#050505";
    ctx.fillRect(0, 0, w, h);
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.r, 0, Math.PI * 2);
    ctx.fillStyle = "#0ff";
    ctx.fill();
}

/* ===== ゲームオーバー ===== */
function gameOver() {
    isPlaying = false;
    isInputActive = false;
    cancelAnimationFrame(animationId);

    const t = ((Date.now() - startTime) / 1000).toFixed(2);
    document.getElementById("final").textContent = `Time: ${t}s`;
    document.getElementById("gameover").style.display = "flex";
}

/* ===== ループ ===== */
function loop() {
    if (!isPlaying) return;

    ctx.fillStyle = "rgba(5,5,5,0.35)";
    ctx.fillRect(0, 0, w, h);

    const time = (Date.now() - startTime) / 1000;
    document.getElementById("score").textContent = time.toFixed(2);

    movePlayer();

    ctx.beginPath();
    ctx.arc(player.x, player.y, player.r, 0, Math.PI * 2);
    ctx.fillStyle = "#0ff";
    ctx.fill();

    const diff = 1 + Math.floor(time / 8);
    if (Math.random() < 0.05 + diff * 0.02) spawnEnemy(diff);

    for (const e of enemies) {
        e.x += e.vx;
        e.y += e.vy;
        ctx.beginPath();
        ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2);
        ctx.fillStyle = "#f33";
        ctx.fill();

        if (Math.hypot(player.x - e.x, player.y - e.y) < player.r + e.r) {
            gameOver();
            return;
        }
    }

    animationId = requestAnimationFrame(loop);
}

resize();
</script>
</body>
</html>
